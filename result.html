<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Results & Scoreboard | ET</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#020617;
      --card:#0b1120;
      --accent:#38bdf8;
      --muted:#9ca3af;
      --text:#f9fafb;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Poppins",system-ui;
      background:radial-gradient(circle at top,#0b1120,#020617);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:1.4rem;
      color:var(--text);
    }
    .shell{
      width:100%;
      max-width:1100px;
      background:rgba(15,23,42,0.98);
      border-radius:1.5rem;
      padding:1.4rem 1.6rem 1.9rem;
      border:1px solid rgba(148,163,184,0.6);
      box-shadow:0 20px 40px rgba(0,0,0,0.85);
    }
    header{
      display:flex;
      justify-content:space-between;
      gap:1rem;
      flex-wrap:wrap;
      margin-bottom:1rem;
    }
    header h1{font-size:1.15rem;font-weight:600}
    header p{font-size:0.85rem;color:var(--muted);margin-top:0.2rem}
    .tag{
      font-size:0.78rem;
      padding:0.25rem 0.6rem;
      border-radius:999px;
      border:1px solid rgba(75,85,99,0.9);
      background:rgba(15,23,42,0.95);
      color:var(--muted);
    }
    .grid{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1.6fr);
      gap:1rem;
    }
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card);
      border-radius:1rem;
      padding:0.9rem 1rem 1rem;
      border:1px solid rgba(55,65,81,0.9);
    }
    .card h2{
      font-size:0.98rem;
      margin-bottom:0.4rem;
      display:flex;align-items:center;gap:0.4rem;
    }
    .card h2 span.icon{
      width:24px;height:24px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:0.9rem;
      background:rgba(56,189,248,0.16);
    }
    .small{font-size:0.8rem;color:var(--muted);margin-bottom:0.5rem;}
    .highlight-box{
      border-radius:0.9rem;
      border:1px solid rgba(56,189,248,0.6);
      background:rgba(15,23,42,0.96);
      padding:0.6rem 0.8rem;
      font-size:0.82rem;
      margin-bottom:0.6rem;
    }
    .highlight-box span.label{color:var(--muted);}
    .highlight-box strong{font-weight:600;}
    .btn{
      border:none;
      border-radius:999px;
      padding:0.55rem 1.2rem;
      font-size:0.85rem;
      background:linear-gradient(135deg,#38bdf8,#2563eb);
      color:white;
      cursor:pointer;
      box-shadow:0 12px 22px rgba(37,99,235,0.7);
      display:inline-flex;align-items:center;justify-content:center;gap:0.3rem;
      margin-top:0.6rem;
    }
    .btn:disabled{opacity:0.5;cursor:not-allowed;box-shadow:none}
    .table-wrap{
      max-height:430px;
      overflow:auto;
      border-radius:0.9rem;
      border:1px solid rgba(31,41,55,0.9);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:0.78rem;
    }
    thead{
      position:sticky;top:0;
      background:#020617;
      z-index:1;
    }
    th,td{
      padding:0.35rem 0.45rem;
      border-bottom:1px solid rgba(31,41,55,0.9);
      text-align:left;
    }
    th{
      font-weight:500;
      color:var(--muted);
      font-size:0.75rem;
    }
    tbody tr:nth-child(even){
      background:rgba(15,23,42,0.8);
    }
    .me-row{
      background:rgba(56,189,248,0.16) !important;
    }
    .me-row td{
      border-bottom-color:rgba(56,189,248,0.6);
    }
    .loading{
      font-size:0.8rem;color:var(--muted);
    }
    .err{
      font-size:0.8rem;color:#f97373;margin-top:0.5rem;
    }
    .back-link{
      margin-top:0.6rem;
      font-size:0.8rem;
    }
    .back-link a{color:#38bdf8;text-decoration:none;}
    .back-link a:hover{text-decoration:underline;}
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div>
        <h1>Results & Shared Scoreboard</h1>
        <p>Here is your combined score + the live scoreboard for everyone who played.</p>
      </div>
      <div><span class="tag">Step 3 of 3</span></div>
    </header>

    <div class="grid">
      <section class="card">
        <h2><span class="icon">‚≠ê</span>Your summary</h2>
        <p class="small">Based on card game time + MD quiz accuracy and time.</p>
        <div id="summaryBox" class="highlight-box" style="display:none;"></div>
        <p id="loadingSummary" class="loading">Loading your result from Firebase‚Ä¶</p>
        <p id="errorSummary" class="err" style="display:none;"></p>

        <button id="goThanksBtn" class="btn" disabled>
          Go to Thanks & Reward ‚Üó
        </button>

        <div class="back-link">
          Or <a href="index.html">go back to registration</a>.
        </div>
      </section>

      <section class="card">
        <h2><span class="icon">üìä</span>Scoreboard ‚Äì all players</h2>
        <p class="small">Sorted by total score (higher first). Only students who finished Game 2 appear here.</p>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Roll</th>
                <th>Name</th>
                <th>USN</th>
                <th>Score</th>
                <th>Acc%</th>
                <th>Card s</th>
                <th>Quiz s</th>
              </tr>
            </thead>
            <tbody id="scoreBody">
              <tr><td colspan="8" class="loading">Loading from Firebase‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <p id="errorBoard" class="err" style="display:none;"></p>
      </section>
    </div>
  </div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // TODO: same config as before
    // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAcRrQIHYDctuKdc8QJTx8i5Gi_1b2QbNc",
  authDomain: "et-attendance-game.firebaseapp.com",
  projectId: "et-attendance-game",
  storageBucket: "et-attendance-game.firebasestorage.app",
  messagingSenderId: "398432369224",
  appId: "1:398432369224:web:2d4a76360b0ea3d99e367d",
  measurementId: "G-Z2793VJ1Z9"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    const currentUsn = (params.get("usn") || "").toUpperCase();

    const summaryBox = document.getElementById("summaryBox");
    const loadingSummary = document.getElementById("loadingSummary");
    const errorSummary = document.getElementById("errorSummary");
    const goThanksBtn = document.getElementById("goThanksBtn");

    const scoreBody = document.getElementById("scoreBody");
    const errorBoard = document.getElementById("errorBoard");

    async function loadSummary(){
      if(!currentUsn){
        loadingSummary.style.display = "none";
        errorSummary.textContent = "No USN provided in URL.";
        errorSummary.style.display = "block";
        return;
      }
      try{
        const doc = await db.collection("scores").doc(currentUsn).get();
        loadingSummary.style.display = "none";
        if(!doc.exists){
          errorSummary.textContent = "No score found for your USN. Maybe you didn‚Äôt finish Game 2.";
          errorSummary.style.display = "block";
          return;
        }
        const d = doc.data();
        const accPercent = d.accuracy != null ? (d.accuracy*100).toFixed(0) : "‚Äî";
        summaryBox.innerHTML = `
          <div><span class="label">Name:</span> <strong>${d.name || "Unknown"}</strong></div>
          <div><span class="label">USN:</span> <strong>${d.usn}</strong></div>
          <div><span class="label">Roll:</span> <strong>${d.roll ?? "‚Äî"}</strong></div>
          <div style="margin-top:0.3rem;">
            <span class="label">Total score:</span> <strong>${d.totalScore ?? "‚Äî"}</strong><br/>
            <span class="label">Accuracy:</span> <strong>${accPercent}%</strong><br/>
            <span class="label">Card game time:</span> <strong>${d.gameTime ?? "‚Äî"}s</strong><br/>
            <span class="label">Quiz time:</span> <strong>${d.quizTime ?? "‚Äî"}s</strong>
          </div>
        `;
        summaryBox.style.display = "block";
        goThanksBtn.disabled = false;
      } catch(err){
        console.error(err);
        loadingSummary.style.display = "none";
        errorSummary.textContent = "Failed to load your result from Firebase.";
        errorSummary.style.display = "block";
      }
    }

    async function loadScoreboard(){
      try{
        const snap = await db.collection("scores").where("totalScore", ">", 0).get();
        scoreBody.innerHTML = "";
        if(snap.empty){
          scoreBody.innerHTML = `<tr><td colspan="8" class="loading">No scores yet. Be the first to finish MD's quiz!</td></tr>`;
          return;
        }
        const rows = [];
        snap.forEach(doc=>{
          const d = doc.data();
          rows.push({
            usn: d.usn,
            name: d.name || "Unknown",
            roll: d.roll ?? 0,
            totalScore: d.totalScore ?? 0,
            accuracy: d.accuracy ?? 0,
            gameTime: d.gameTime ?? null,
            quizTime: d.quizTime ?? null
          });
        });
        rows.sort((a,b)=>{
          if(b.totalScore !== a.totalScore) return b.totalScore - a.totalScore;
          return a.roll - b.roll;
        });
        rows.forEach((r,idx)=>{
          const tr = document.createElement("tr");
          if(r.usn === currentUsn) tr.classList.add("me-row");
          tr.innerHTML = `
            <td>${idx+1}</td>
            <td>${r.roll || "‚Äî"}</td>
            <td>${r.name}</td>
            <td>${r.usn}</td>
            <td>${r.totalScore}</td>
            <td>${(r.accuracy*100).toFixed(0)}%</td>
            <td>${r.gameTime != null ? r.gameTime : "‚Äî"}</td>
            <td>${r.quizTime != null ? r.quizTime : "‚Äî"}</td>
          `;
          scoreBody.appendChild(tr);
        });
      } catch(err){
        console.error(err);
        scoreBody.innerHTML = "";
        errorBoard.textContent = "Failed to load scoreboard from Firebase.";
        errorBoard.style.display = "block";
      }
    }

    goThanksBtn.addEventListener("click", ()=>{
      const q = new URLSearchParams({ usn: currentUsn });
      window.location.href = "thanks.html?" + q.toString();
    });

    loadSummary();
    loadScoreboard();
  </script>
</body>
</html>
